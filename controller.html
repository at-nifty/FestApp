<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>コントロール画面</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .section { margin-bottom: 30px; }
    .preview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; }
    video, iframe { width: 100%; height: 200px; background: #000; }
    .control-panel { margin-top: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    label { display: block; margin-top: 10px; }
    select, input[type="text"], input[type="file"] { width: 100%; }
    button { margin-top: 10px; width: 100%; padding: 10px; font-size: 1em; }
  </style>
</head>
<body>
  <h1>コントロール画面</h1>

  <div class="section">
    <h2>プレビュー</h2>
    <h3>プロジェクター（Main/Sub）</h3>
    <div class="preview-grid">
      <iframe id="mainProjectorPreview"></iframe>
      <iframe id="subProjectorPreview"></iframe>
    </div>
    <h3>モニター</h3>
    <div class="preview-grid">
      <iframe id="monitorPreview0"></iframe>
      <iframe id="monitorPreview1"></iframe>
      <iframe id="monitorPreview2"></iframe>
      <iframe id="monitorPreview3"></iframe>
      <iframe id="monitorPreview4"></iframe>
      <iframe id="monitorPreview5"></iframe>
      <iframe id="monitorPreview6"></iframe>
      <iframe id="monitorPreview7"></iframe>
    </div>
    <h3>カメラ映像</h3>
    <div class="preview-grid">
      <video id="cameraPreview0" autoplay></video>
      <video id="cameraPreview1" autoplay></video>
      <video id="cameraPreview2" autoplay></video>
      <video id="cameraPreview3" autoplay></video>
      <video id="cameraPreview4" autoplay></video>
      <video id="cameraPreview5" autoplay></video>
      <video id="cameraPreview6" autoplay></video>
      <video id="cameraPreview7" autoplay></video>
    </div>
  </div>

  <div class="section">
    <h2>表示内容の変更</h2>
    <div class="control-panel">
      <label for="target">対象画面</label>
      <select id="target">
        <option value="mainProjector">メインプロジェクター</option>
        <option value="subProjector">サブプロジェクター</option>
        <option value="monitor0">モニター0</option>
        <option value="monitor1">モニター1</option>
        <option value="monitor2">モニター2</option>
        <option value="monitor3">モニター3</option>
        <option value="monitor4">モニター4</option>
        <option value="monitor5">モニター5</option>
        <option value="monitor6">モニター6</option>
        <option value="monitor7">モニター7</option>
      </select>

      <label for="textContent">案内/歌詞表示テキスト</label>
      <input type="text" id="textContent" placeholder="ここにテキストを入力" />

      <label for="videoURL">動画URL</label>
      <input type="text" id="videoURL" placeholder="https://example.com/video.mp4" />

      <label for="videoFile">動画ファイル（mp4）</label>
      <input type="file" id="videoFile" accept="video/mp4" />

      <label for="cameraNumber">映すカメラ番号（0-7）</label>
      <select id="cameraNumber">
        <option value="">--選択--</option>
        <option value="0">カメラ0</option>
        <option value="1">カメラ1</option>
        <option value="2">カメラ2</option>
        <option value="3">カメラ3</option>
        <option value="4">カメラ4</option>
        <option value="5">カメラ5</option>
        <option value="6">カメラ6</option>
        <option value="7">カメラ7</option>
      </select>

      <button onclick="applyContent()">適用</button>
    </div>
  </div>

  <div class="section">
    <h2>歌詞送り機能（LyricProjection風）</h2>
    <div class="control-panel">
      <label for="lyricsTarget">対象画面</label>
      <select id="lyricsTarget">
        <option value="mainProjector">メインプロジェクター</option>
        <option value="subProjector">サブプロジェクター</option>
      </select>

      <label for="lyricsFile">歌詞ファイル（.txt）</label>
      <input type="file" id="lyricsFile" accept=".txt" />

      <button onclick="prevLyric()">← 前へ</button>
      <button onclick="nextLyric()">次へ →</button>
    </div>
  </div>

  <script>
    function applyContent() {
      const target = document.getElementById("target").value;
      const text = document.getElementById("textContent").value;
      const videoURL = document.getElementById("videoURL").value;
      const videoFile = document.getElementById("videoFile").files[0];
      const cameraNum = document.getElementById("cameraNumber").value;

      const targetFrame = document.getElementById(`${target}Preview`);
      if (!targetFrame) return alert("対象が不正です");

      if (text) {
        targetFrame.srcdoc = `<div style='font-size:3em;text-align:center;'>${text}</div>`;
        return;
      }

      if (videoURL) {
        targetFrame.src = videoURL;
        return;
      }

      if (videoFile) {
        const url = URL.createObjectURL(videoFile);
        targetFrame.src = url;
        return;
      }

      if (cameraNum !== "") {
        const stream = document.getElementById(`cameraPreview${cameraNum}`).srcObject;
        const camId = `liveCam${cameraNum}`;
        targetFrame.srcdoc = `<video autoplay playsinline id="${camId}" width="100%" height="100%"></video>`;
        const interval = setInterval(() => {
          const video = targetFrame.contentDocument && targetFrame.contentDocument.getElementById(camId);
          if (video) {
            video.srcObject = stream;
            clearInterval(interval);
          }
        }, 100);
      }
    }

    let lyricsLines = [];
    let currentLine = -1;

    document.getElementById("lyricsFile").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        lyricsLines = reader.result.split('\n').map(l => l.trim()).filter(l => l);
        currentLine = -1;
        alert("歌詞ファイルを読み込みました。");
      };
      reader.readAsText(file);
    });

    function nextLyric() {
      if (currentLine + 1 >= lyricsLines.length) return;
      currentLine++;
      showLyric(lyricsLines[currentLine]);
    }

    function prevLyric() {
      if (currentLine - 1 < 0) return;
      currentLine--;
      showLyric(lyricsLines[currentLine]);
    }

    function showLyric(line) {
  const target = document.getElementById("lyricsTarget").value;
  const frame = document.getElementById(`${target}Preview`);

  let html = `<style>
    body { background: black; margin: 0; overflow: hidden; }
    .lyric-su { position: absolute; top: 10px; left: 10px; font-size: 2em; color: white; }
    .lyric-sd { position: absolute; bottom: 10px; right: 10px; font-size: 2em; color: white; }
    .lyric-f  { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3em; color: white; text-align: center; }
  </style><body>`;

  // 保持される前の歌詞状態
  const existingDoc = frame.contentDocument;
  const su = existingDoc?.querySelector(".lyric-su")?.outerHTML || "";
  const sd = existingDoc?.querySelector(".lyric-sd")?.outerHTML || "";
  const f  = existingDoc?.querySelector(".lyric-f")?.outerHTML || "";

  let newSu = su;
  let newSd = sd;
  let newF  = f;

  if (line.startsWith("SU ")) {
    newSu = `<div class='lyric-su'>${line.substring(3)}</div>`;
  } else if (line.startsWith("SD ")) {
    newSd = `<div class='lyric-sd'>${line.substring(3)}</div>`;
  } else if (line.startsWith("F ")) {
    newF = `<div class='lyric-f'>${line.substring(2)}</div>`;
  } else if (line === "Clear") {
    newSu = "";
    newSd = "";
    newF = "";
  } else {
    newF = `<div class='lyric-f'>${line}</div>`;
  }

  html += `${newSu}${newSd}${newF}`;
  html += "</body>";
  frame.srcdoc = html;
    }

    function setupCameraPreview(index) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          document.getElementById(`cameraPreview${index}`).srcObject = stream;
        })
        .catch(err => console.error("Camera access error:", err));
    }

    for (let i = 0; i < 8; i++) {
      setupCameraPreview(i);
    }
  </script>
</body>
</html>
